{"version":3,"sources":["../../../src/server/mcp/get-mcp-middleware.ts"],"sourcesContent":["import type { ServerResponse, IncomingMessage } from 'http'\nimport {\n  getOrCreateMcpServer,\n  type McpServerOptions,\n} from './get-or-create-mcp-server'\nimport { parseBody } from '../api-utils/node/parse-body'\nimport { StreamableHTTPServerTransport } from 'next/dist/compiled/@modelcontextprotocol/sdk/server/streamableHttp'\n\nexport function getMcpMiddleware(options: McpServerOptions) {\n  return async function (\n    req: IncomingMessage,\n    res: ServerResponse,\n    next: () => void\n  ): Promise<void> {\n    const { pathname } = new URL(req.url || '', 'http://n')\n    if (!pathname.startsWith('/_next/mcp')) {\n      return next()\n    }\n    const mcpServer = getOrCreateMcpServer(options)\n    const transport = new StreamableHTTPServerTransport({\n      sessionIdGenerator: undefined,\n    })\n    try {\n      res.on('close', () => {\n        transport.close()\n      })\n      await mcpServer.connect(transport)\n      const parsedBody = await parseBody(req, 1024 * 1024) // 1MB limit\n      await transport.handleRequest(req, res, parsedBody)\n    } catch (error) {\n      if (!res.headersSent) {\n        res.statusCode = 500\n        res.setHeader('Content-Type', 'application/json; charset=utf-8')\n        res.end(\n          JSON.stringify({\n            jsonrpc: '2.0',\n            error: { code: -32000, message: 'Internal server error' },\n            id: null,\n          })\n        )\n      }\n    }\n  }\n}\n"],"names":["getMcpMiddleware","options","req","res","next","pathname","URL","url","startsWith","mcpServer","getOrCreateMcpServer","transport","StreamableHTTPServerTransport","sessionIdGenerator","undefined","on","close","connect","parsedBody","parseBody","handleRequest","error","headersSent","statusCode","setHeader","end","JSON","stringify","jsonrpc","code","message","id"],"mappings":";;;;+BAQgBA;;;eAAAA;;;sCAJT;2BACmB;gCACoB;AAEvC,SAASA,iBAAiBC,OAAyB;IACxD,OAAO,eACLC,GAAoB,EACpBC,GAAmB,EACnBC,IAAgB;QAEhB,MAAM,EAAEC,QAAQ,EAAE,GAAG,IAAIC,IAAIJ,IAAIK,GAAG,IAAI,IAAI;QAC5C,IAAI,CAACF,SAASG,UAAU,CAAC,eAAe;YACtC,OAAOJ;QACT;QACA,MAAMK,YAAYC,IAAAA,0CAAoB,EAACT;QACvC,MAAMU,YAAY,IAAIC,6CAA6B,CAAC;YAClDC,oBAAoBC;QACtB;QACA,IAAI;YACFX,IAAIY,EAAE,CAAC,SAAS;gBACdJ,UAAUK,KAAK;YACjB;YACA,MAAMP,UAAUQ,OAAO,CAACN;YACxB,MAAMO,aAAa,MAAMC,IAAAA,oBAAS,EAACjB,KAAK,OAAO,MAAM,YAAY;;YACjE,MAAMS,UAAUS,aAAa,CAAClB,KAAKC,KAAKe;QAC1C,EAAE,OAAOG,OAAO;YACd,IAAI,CAAClB,IAAImB,WAAW,EAAE;gBACpBnB,IAAIoB,UAAU,GAAG;gBACjBpB,IAAIqB,SAAS,CAAC,gBAAgB;gBAC9BrB,IAAIsB,GAAG,CACLC,KAAKC,SAAS,CAAC;oBACbC,SAAS;oBACTP,OAAO;wBAAEQ,MAAM,CAAC;wBAAOC,SAAS;oBAAwB;oBACxDC,IAAI;gBACN;YAEJ;QACF;IACF;AACF","ignoreList":[0]}