{"version":3,"sources":["../../src/lib/turbopack-warning.ts"],"sourcesContent":["import type { NextConfigComplete } from '../server/config-shared'\nimport loadConfig from '../server/config'\nimport * as Log from '../build/output/log'\nimport {\n  PHASE_DEVELOPMENT_SERVER,\n  PHASE_PRODUCTION_BUILD,\n} from '../shared/lib/constants'\n\nconst unsupportedTurbopackNextConfigOptions = [\n  // Left to be implemented (priority)\n  // 'experimental.clientRouterFilter',\n  // 'experimental.optimizePackageImports',\n  // 'compiler.emotion',\n  // 'compiler.reactRemoveProperties',\n  // 'compiler.relay',\n  // 'compiler.removeConsole',\n  // 'compiler.styledComponents',\n  'experimental.fetchCacheKeyPrefix',\n\n  // Left to be implemented\n  // 'excludeDefaultMomentLocales',\n  // 'experimental.optimizeServerReact',\n  'experimental.clientRouterFilterAllowedRate',\n  // 'experimental.serverMinification',\n  // 'experimental.serverSourceMaps',\n\n  'experimental.allowedRevalidateHeaderKeys',\n  'experimental.extensionAlias',\n  'experimental.fallbackNodePolyfills',\n\n  'experimental.sri.algorithm',\n  'experimental.swcTraceProfiling',\n\n  // Left to be implemented (Might not be needed for Turbopack)\n  'experimental.craCompat',\n  'experimental.disablePostcssPresetEnv',\n  'experimental.esmExternals',\n  // This is used to force swc-loader to run regardless of finding Babel.\n  'experimental.forceSwcTransforms',\n  'experimental.fullySpecified',\n  'experimental.urlImports',\n  'experimental.slowModuleDetection',\n]\n\n/**  */\nexport async function validateTurboNextConfig({\n  dir,\n  isDev,\n}: {\n  dir: string\n  isDev?: boolean\n}) {\n  const { defaultConfig } =\n    require('../server/config-shared') as typeof import('../server/config-shared')\n  const { cyan, red, underline } =\n    require('../lib/picocolors') as typeof import('../lib/picocolors')\n  const { interopDefault } =\n    require('../lib/interop-default') as typeof import('../lib/interop-default')\n\n  let unsupportedParts = ''\n\n  let hasWebpackConfig = false\n  let hasTurboConfig = false\n\n  const unsupportedConfig: string[] = []\n  let rawNextConfig: NextConfigComplete = {} as NextConfigComplete\n\n  const phase = isDev ? PHASE_DEVELOPMENT_SERVER : PHASE_PRODUCTION_BUILD\n  try {\n    rawNextConfig = interopDefault(\n      await loadConfig(phase, dir, {\n        rawConfig: true,\n      })\n    )\n\n    if (typeof rawNextConfig === 'function') {\n      rawNextConfig = (rawNextConfig as any)(phase, {\n        defaultConfig,\n      })\n    }\n    hasWebpackConfig = Boolean(rawNextConfig.webpack)\n    hasTurboConfig = Boolean(rawNextConfig.turbopack)\n\n    const flattenKeys = (obj: any, prefix: string = ''): string[] => {\n      let keys: string[] = []\n\n      for (const key in obj) {\n        const value = obj?.[key]\n        if (typeof value === 'undefined') {\n          continue\n        }\n\n        const pre = prefix.length ? `${prefix}.` : ''\n\n        if (\n          typeof value === 'object' &&\n          !Array.isArray(value) &&\n          value !== null\n        ) {\n          keys = keys.concat(flattenKeys(value, pre + key))\n        } else {\n          keys.push(pre + key)\n        }\n      }\n\n      return keys\n    }\n\n    const getDeepValue = (obj: any, keys: string | string[]): any => {\n      if (typeof keys === 'string') {\n        keys = keys.split('.')\n      }\n      if (keys.length === 1) {\n        return obj?.[keys?.[0]]\n      }\n      return getDeepValue(obj?.[keys?.[0]], keys.slice(1))\n    }\n\n    const customKeys = flattenKeys(rawNextConfig)\n\n    for (const key of customKeys) {\n      if (key.startsWith('experimental.turbo')) {\n        hasTurboConfig = true\n      }\n\n      const isUnsupported =\n        unsupportedTurbopackNextConfigOptions.some(\n          (unsupportedKey) =>\n            // Either the key matches (or is a more specific subkey) of\n            // unsupportedKey, or the key is the path to a specific subkey.\n            // | key     | unsupportedKey |\n            // |---------|----------------|\n            // | foo     | foo            |\n            // | foo.bar | foo            |\n            // | foo     | foo.bar        |\n            key.startsWith(unsupportedKey) ||\n            unsupportedKey.startsWith(`${key}.`)\n        ) &&\n        getDeepValue(rawNextConfig, key) !== getDeepValue(defaultConfig, key)\n\n      if (isUnsupported) {\n        unsupportedConfig.push(key)\n      }\n    }\n  } catch (e) {\n    Log.error('Unexpected error occurred while checking config', e)\n  }\n\n  // If the build was defaulted to Turbopack, we want to warn about possibly ignored webpack\n  // configuration. Otherwise the user explicitly picked turbopack and thus we expect that\n  // they have configured it correctly.\n  if (process.env.TURBOPACK === 'auto' && hasWebpackConfig && !hasTurboConfig) {\n    const configFile = rawNextConfig.configFileName ?? 'your Next config file'\n    Log.error(\n      `ERROR: This build is using Turbopack, with a \\`webpack\\` config and no \\`turbopack\\` config.\n   This may be a mistake.\n\n   As of Next.js 16 Turbopack is enabled by default and\n   custom webpack configurations may need to be migrated to Turbopack.\n\n   NOTE: your \\`webpack\\` config may have been added by a configuration plugin.\n\n   To configure Turbopack, see https://nextjs.org/docs/app/api-reference/next-config-js/turbopack\n\n   TIP: Many applications work fine under Turbopack with no configuration,\n   if that is the case for you, you can silence this error by passing the\n   \\`--turbopack\\` or \\`--webpack\\` flag explicitly or simply setting an \n   empty turbopack config in ${configFile} (e.g. \\`turbopack: {}\\`).`\n    )\n\n    process.exit(1)\n  }\n\n  if (unsupportedConfig.length) {\n    unsupportedParts += `\\n\\n- Unsupported Next.js configuration option(s) (${cyan(\n      'next.config.js'\n    )})\\n  Turbopack will ignore the following configuration options:\\n${unsupportedConfig\n      .map((name) => `    - ${red(name)}\\n`)\n      .join('')}`\n  }\n\n  if (unsupportedParts) {\n    Log.error(\n      `You are using configuration and/or tools that are not yet\\nsupported by Next.js with Turbopack:\\n${unsupportedParts}\\n`\n    )\n\n    Log.warn(\n      'Learn more about how to configure Turbopack with Next.js:\\n' +\n        underline(\n          'https://nextjs.org/docs/app/api-reference/config/next-config-js/turbopack'\n        )\n    )\n  }\n\n  return rawNextConfig\n}\n"],"names":["validateTurboNextConfig","unsupportedTurbopackNextConfigOptions","dir","isDev","defaultConfig","require","cyan","red","underline","interopDefault","unsupportedParts","hasWebpackConfig","hasTurboConfig","unsupportedConfig","rawNextConfig","phase","PHASE_DEVELOPMENT_SERVER","PHASE_PRODUCTION_BUILD","loadConfig","rawConfig","Boolean","webpack","turbopack","flattenKeys","obj","prefix","keys","key","value","pre","length","Array","isArray","concat","push","getDeepValue","split","slice","customKeys","startsWith","isUnsupported","some","unsupportedKey","e","Log","error","process","env","TURBOPACK","configFile","configFileName","exit","map","name","join","warn"],"mappings":"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","ignoreList":[0]}