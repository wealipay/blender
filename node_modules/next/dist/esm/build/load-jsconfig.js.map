{"version":3,"sources":["../../src/build/load-jsconfig.ts"],"sourcesContent":["import path from 'path'\nimport fs from 'fs'\nimport type { NextConfigComplete } from '../server/config-shared'\nimport * as Log from './output/log'\nimport { getTypeScriptConfiguration } from '../lib/typescript/getTypeScriptConfiguration'\nimport { readFileSync } from 'fs'\nimport isError from '../lib/is-error'\nimport { hasNecessaryDependencies } from '../lib/has-necessary-dependencies'\n\nlet TSCONFIG_WARNED = false\n\nexport function parseJsonFile(filePath: string) {\n  const JSON5 =\n    require('next/dist/compiled/json5') as typeof import('next/dist/compiled/json5')\n  const contents = readFileSync(filePath, 'utf8')\n\n  // Special case an empty file\n  if (contents.trim() === '') {\n    return {}\n  }\n\n  try {\n    return JSON5.parse(contents)\n  } catch (err) {\n    if (!isError(err)) throw err\n    const { codeFrameColumns } =\n      require('next/dist/compiled/babel/code-frame') as typeof import('next/dist/compiled/babel/code-frame')\n    const codeFrame = codeFrameColumns(\n      String(contents),\n      {\n        start: {\n          line: (err as Error & { lineNumber?: number }).lineNumber || 0,\n          column: (err as Error & { columnNumber?: number }).columnNumber || 0,\n        },\n      },\n      { message: err.message, highlightCode: true }\n    )\n    throw new Error(`Failed to parse \"${filePath}\":\\n${codeFrame}`)\n  }\n}\n\nexport type ResolvedBaseUrl =\n  | { baseUrl: string; isImplicit: boolean }\n  | undefined\n\nexport type JsConfig = { compilerOptions: Record<string, any> } | undefined\n\nexport default async function loadJsConfig(\n  dir: string,\n  config: NextConfigComplete\n): Promise<{\n  useTypeScript: boolean\n  jsConfig: JsConfig\n  jsConfigPath?: string\n  resolvedBaseUrl: ResolvedBaseUrl\n}> {\n  let typeScriptPath: string | undefined\n  try {\n    const deps = hasNecessaryDependencies(dir, [\n      {\n        pkg: 'typescript',\n        file: 'typescript/lib/typescript.js',\n        exportsRestrict: true,\n      },\n    ])\n    typeScriptPath = deps.resolved.get('typescript')\n  } catch {}\n  const tsConfigFileName = config.typescript.tsconfigPath || 'tsconfig.json'\n  const tsConfigPath = path.join(dir, tsConfigFileName)\n  const useTypeScript = Boolean(typeScriptPath && fs.existsSync(tsConfigPath))\n\n  let implicitBaseurl\n  let jsConfig: { compilerOptions: Record<string, any> } | undefined\n  // jsconfig is a subset of tsconfig\n  if (useTypeScript) {\n    if (tsConfigFileName !== 'tsconfig.json' && TSCONFIG_WARNED === false) {\n      TSCONFIG_WARNED = true\n      Log.info(`Using tsconfig file: ${tsConfigFileName}`)\n    }\n\n    const ts = (await Promise.resolve(\n      require(typeScriptPath!)\n    )) as typeof import('typescript')\n    const tsConfig = await getTypeScriptConfiguration(ts, tsConfigPath, true)\n    jsConfig = { compilerOptions: tsConfig.options }\n    implicitBaseurl = path.dirname(tsConfigPath)\n  }\n\n  const jsConfigPath = path.join(dir, 'jsconfig.json')\n  if (!useTypeScript && fs.existsSync(jsConfigPath)) {\n    jsConfig = parseJsonFile(jsConfigPath)\n    implicitBaseurl = path.dirname(jsConfigPath)\n  }\n\n  let resolvedBaseUrl: ResolvedBaseUrl\n  if (jsConfig?.compilerOptions?.baseUrl) {\n    resolvedBaseUrl = {\n      baseUrl: path.resolve(dir, jsConfig.compilerOptions.baseUrl),\n      isImplicit: false,\n    }\n  } else {\n    if (implicitBaseurl) {\n      resolvedBaseUrl = {\n        baseUrl: implicitBaseurl,\n        isImplicit: true,\n      }\n    }\n  }\n\n  return {\n    useTypeScript,\n    jsConfig,\n    resolvedBaseUrl,\n    jsConfigPath: useTypeScript\n      ? tsConfigPath\n      : fs.existsSync(jsConfigPath)\n        ? jsConfigPath\n        : undefined,\n  }\n}\n"],"names":["path","fs","Log","getTypeScriptConfiguration","readFileSync","isError","hasNecessaryDependencies","TSCONFIG_WARNED","parseJsonFile","filePath","JSON5","require","contents","trim","parse","err","codeFrameColumns","codeFrame","String","start","line","lineNumber","column","columnNumber","message","highlightCode","Error","loadJsConfig","dir","config","jsConfig","typeScriptPath","deps","pkg","file","exportsRestrict","resolved","get","tsConfigFileName","typescript","tsconfigPath","tsConfigPath","join","useTypeScript","Boolean","existsSync","implicitBaseurl","info","ts","Promise","resolve","tsConfig","compilerOptions","options","dirname","jsConfigPath","resolvedBaseUrl","baseUrl","isImplicit","undefined"],"mappings":"AAAA,OAAOA,UAAU,OAAM;AACvB,OAAOC,QAAQ,KAAI;AAEnB,YAAYC,SAAS,eAAc;AACnC,SAASC,0BAA0B,QAAQ,+CAA8C;AACzF,SAASC,YAAY,QAAQ,KAAI;AACjC,OAAOC,aAAa,kBAAiB;AACrC,SAASC,wBAAwB,QAAQ,oCAAmC;AAE5E,IAAIC,kBAAkB;AAEtB,OAAO,SAASC,cAAcC,QAAgB;IAC5C,MAAMC,QACJC,QAAQ;IACV,MAAMC,WAAWR,aAAaK,UAAU;IAExC,6BAA6B;IAC7B,IAAIG,SAASC,IAAI,OAAO,IAAI;QAC1B,OAAO,CAAC;IACV;IAEA,IAAI;QACF,OAAOH,MAAMI,KAAK,CAACF;IACrB,EAAE,OAAOG,KAAK;QACZ,IAAI,CAACV,QAAQU,MAAM,MAAMA;QACzB,MAAM,EAAEC,gBAAgB,EAAE,GACxBL,QAAQ;QACV,MAAMM,YAAYD,iBAChBE,OAAON,WACP;YACEO,OAAO;gBACLC,MAAM,AAACL,IAAwCM,UAAU,IAAI;gBAC7DC,QAAQ,AAACP,IAA0CQ,YAAY,IAAI;YACrE;QACF,GACA;YAAEC,SAAST,IAAIS,OAAO;YAAEC,eAAe;QAAK;QAE9C,MAAM,qBAAyD,CAAzD,IAAIC,MAAM,CAAC,iBAAiB,EAAEjB,SAAS,IAAI,EAAEQ,WAAW,GAAxD,qBAAA;mBAAA;wBAAA;0BAAA;QAAwD;IAChE;AACF;AAQA,eAAe,eAAeU,aAC5BC,GAAW,EACXC,MAA0B;QA8CtBC;IAvCJ,IAAIC;IACJ,IAAI;QACF,MAAMC,OAAO1B,yBAAyBsB,KAAK;YACzC;gBACEK,KAAK;gBACLC,MAAM;gBACNC,iBAAiB;YACnB;SACD;QACDJ,iBAAiBC,KAAKI,QAAQ,CAACC,GAAG,CAAC;IACrC,EAAE,OAAM,CAAC;IACT,MAAMC,mBAAmBT,OAAOU,UAAU,CAACC,YAAY,IAAI;IAC3D,MAAMC,eAAezC,KAAK0C,IAAI,CAACd,KAAKU;IACpC,MAAMK,gBAAgBC,QAAQb,kBAAkB9B,GAAG4C,UAAU,CAACJ;IAE9D,IAAIK;IACJ,IAAIhB;IACJ,mCAAmC;IACnC,IAAIa,eAAe;QACjB,IAAIL,qBAAqB,mBAAmB/B,oBAAoB,OAAO;YACrEA,kBAAkB;YAClBL,IAAI6C,IAAI,CAAC,CAAC,qBAAqB,EAAET,kBAAkB;QACrD;QAEA,MAAMU,KAAM,MAAMC,QAAQC,OAAO,CAC/BvC,QAAQoB;QAEV,MAAMoB,WAAW,MAAMhD,2BAA2B6C,IAAIP,cAAc;QACpEX,WAAW;YAAEsB,iBAAiBD,SAASE,OAAO;QAAC;QAC/CP,kBAAkB9C,KAAKsD,OAAO,CAACb;IACjC;IAEA,MAAMc,eAAevD,KAAK0C,IAAI,CAACd,KAAK;IACpC,IAAI,CAACe,iBAAiB1C,GAAG4C,UAAU,CAACU,eAAe;QACjDzB,WAAWtB,cAAc+C;QACzBT,kBAAkB9C,KAAKsD,OAAO,CAACC;IACjC;IAEA,IAAIC;IACJ,IAAI1B,6BAAAA,4BAAAA,SAAUsB,eAAe,qBAAzBtB,0BAA2B2B,OAAO,EAAE;QACtCD,kBAAkB;YAChBC,SAASzD,KAAKkD,OAAO,CAACtB,KAAKE,SAASsB,eAAe,CAACK,OAAO;YAC3DC,YAAY;QACd;IACF,OAAO;QACL,IAAIZ,iBAAiB;YACnBU,kBAAkB;gBAChBC,SAASX;gBACTY,YAAY;YACd;QACF;IACF;IAEA,OAAO;QACLf;QACAb;QACA0B;QACAD,cAAcZ,gBACVF,eACAxC,GAAG4C,UAAU,CAACU,gBACZA,eACAI;IACR;AACF","ignoreList":[0]}