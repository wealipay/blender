{"version":3,"sources":["../../../../src/build/webpack/plugins/build-manifest-plugin.ts"],"sourcesContent":["import type { BloomFilter } from '../../../shared/lib/bloom-filter'\nimport type { CustomRoutes } from '../../../lib/load-custom-routes'\nimport devalue from 'next/dist/compiled/devalue'\nimport { webpack, sources } from 'next/dist/compiled/webpack/webpack'\nimport {\n  BUILD_MANIFEST,\n  MIDDLEWARE_BUILD_MANIFEST,\n  CLIENT_STATIC_FILES_PATH,\n  CLIENT_STATIC_FILES_RUNTIME_MAIN,\n  CLIENT_STATIC_FILES_RUNTIME_MAIN_APP,\n  CLIENT_STATIC_FILES_RUNTIME_POLYFILLS_SYMBOL,\n  CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH,\n  SYSTEM_ENTRYPOINTS,\n} from '../../../shared/lib/constants'\nimport type { BuildManifest } from '../../../server/get-page-files'\nimport getRouteFromEntrypoint from '../../../server/get-route-from-entrypoint'\nimport { getSortedRoutes } from '../../../shared/lib/router/utils'\nimport { Span } from '../../../trace'\nimport { getCompilationSpan } from '../utils'\nimport {\n  createEdgeRuntimeManifest,\n  normalizeRewritesForBuildManifest,\n  processRoute,\n  srcEmptySsgManifest,\n  type ClientBuildManifest,\n} from './build-manifest-plugin-utils'\n\ntype DeepMutable<T> = { -readonly [P in keyof T]: DeepMutable<T[P]> }\n\n// nodejs: '/static/<build id>/low-priority.js'\nfunction buildNodejsLowPriorityPath(filename: string, buildId: string) {\n  return `${CLIENT_STATIC_FILES_PATH}/${buildId}/${filename}`\n}\n\n// This function takes the asset map generated in BuildManifestPlugin and creates a\n// reduced version to send to the client.\nexport function generateClientManifest(\n  assetMap: BuildManifest,\n  rewrites: CustomRoutes['rewrites'],\n  clientRouterFilters?: {\n    staticFilter: ReturnType<BloomFilter['export']>\n    dynamicFilter: ReturnType<BloomFilter['export']>\n  },\n  compiler?: any,\n  compilation?: any\n): string | undefined {\n  const compilationSpan = compilation\n    ? getCompilationSpan(compilation)\n    : compiler\n      ? getCompilationSpan(compiler)\n      : new Span({ name: 'client-manifest' })\n\n  const genClientManifestSpan = compilationSpan?.traceChild(\n    'NextJsBuildManifest-generateClientManifest'\n  )\n\n  return genClientManifestSpan?.traceFn(() => {\n    const clientManifest: ClientBuildManifest = {\n      __rewrites: normalizeRewritesForBuildManifest(rewrites) as any,\n      __routerFilterStatic: clientRouterFilters?.staticFilter as any,\n      __routerFilterDynamic: clientRouterFilters?.dynamicFilter as any,\n    }\n    const appDependencies = new Set(assetMap.pages['/_app'])\n    const sortedPageKeys = getSortedRoutes(Object.keys(assetMap.pages))\n\n    sortedPageKeys.forEach((page) => {\n      const dependencies = assetMap.pages[page]\n\n      if (page === '/_app') return\n      // Filter out dependencies in the _app entry, because those will have already\n      // been loaded by the client prior to a navigation event\n      const filteredDeps = dependencies.filter(\n        (dep) => !appDependencies.has(dep)\n      )\n\n      // The manifest can omit the page if it has no requirements\n      if (filteredDeps.length) {\n        clientManifest[page] = filteredDeps\n      }\n    })\n    // provide the sorted pages as an array so we don't rely on the object's keys\n    // being in order and we don't slow down look-up time for page assets\n    clientManifest.sortedPages = sortedPageKeys\n\n    return devalue(clientManifest)\n  })\n}\n\nexport function getEntrypointFiles(entrypoint: any): string[] {\n  return (\n    entrypoint\n      ?.getFiles()\n      .filter((file: string) => {\n        // We don't want to include `.hot-update.js` files into the initial page\n        return /(?<!\\.hot-update)\\.(js|css)($|\\?)/.test(file)\n      })\n      .map((file: string) => file.replace(/\\\\/g, '/')) ?? []\n  )\n}\n\n// This plugin creates a build-manifest.json for all assets that are being output\n// It has a mapping of \"entry\" filename to real filename. Because the real filename can be hashed in production\nexport default class BuildManifestPlugin {\n  private buildId: string\n  private rewrites: CustomRoutes['rewrites']\n  private isDevFallback: boolean\n  private appDirEnabled: boolean\n  private clientRouterFilters?: Parameters<typeof generateClientManifest>[2]\n\n  constructor(options: {\n    buildId: string\n    rewrites: CustomRoutes['rewrites']\n    isDevFallback?: boolean\n    appDirEnabled: boolean\n    clientRouterFilters?: Parameters<typeof generateClientManifest>[2]\n  }) {\n    this.buildId = options.buildId\n    this.isDevFallback = !!options.isDevFallback\n    this.rewrites = {\n      beforeFiles: [],\n      afterFiles: [],\n      fallback: [],\n    }\n    this.appDirEnabled = options.appDirEnabled\n    this.clientRouterFilters = options.clientRouterFilters\n    this.rewrites.beforeFiles = options.rewrites.beforeFiles.map(processRoute)\n    this.rewrites.afterFiles = options.rewrites.afterFiles.map(processRoute)\n    this.rewrites.fallback = options.rewrites.fallback.map(processRoute)\n  }\n\n  createAssets(compiler: any, compilation: any) {\n    const compilationSpan =\n      getCompilationSpan(compilation) ?? getCompilationSpan(compiler)\n    if (!compilationSpan) {\n      throw new Error('No span found for compilation')\n    }\n\n    const createAssetsSpan = compilationSpan.traceChild(\n      'NextJsBuildManifest-createassets'\n    )\n\n    return createAssetsSpan.traceFn(() => {\n      const entrypoints: Map<string, any> = compilation.entrypoints\n      const assetMap: DeepMutable<BuildManifest> = {\n        polyfillFiles: [],\n        devFiles: [],\n        lowPriorityFiles: [],\n        rootMainFiles: [],\n        rootMainFilesTree: {},\n        pages: { '/_app': [] },\n      }\n\n      const mainFiles = new Set(\n        getEntrypointFiles(entrypoints.get(CLIENT_STATIC_FILES_RUNTIME_MAIN))\n      )\n\n      if (this.appDirEnabled) {\n        assetMap.rootMainFiles = [\n          ...new Set(\n            getEntrypointFiles(\n              entrypoints.get(CLIENT_STATIC_FILES_RUNTIME_MAIN_APP)\n            )\n          ),\n        ]\n      }\n\n      const compilationAssets: {\n        name: string\n        source: typeof sources.RawSource\n        info: object\n      }[] = compilation.getAssets()\n\n      assetMap.polyfillFiles = compilationAssets\n        .filter((p) => {\n          // Ensure only .js files are passed through\n          if (!p.name.endsWith('.js')) {\n            return false\n          }\n\n          return (\n            p.info && CLIENT_STATIC_FILES_RUNTIME_POLYFILLS_SYMBOL in p.info\n          )\n        })\n        .map((v) => v.name)\n\n      assetMap.devFiles = getEntrypointFiles(\n        entrypoints.get(CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH)\n      ).filter((file) => !mainFiles.has(file))\n\n      for (const entrypoint of compilation.entrypoints.values()) {\n        if (SYSTEM_ENTRYPOINTS.has(entrypoint.name)) continue\n        const pagePath = getRouteFromEntrypoint(entrypoint.name)\n\n        if (!pagePath) {\n          continue\n        }\n\n        const filesForPage = getEntrypointFiles(entrypoint)\n\n        assetMap.pages[pagePath] = [...new Set([...mainFiles, ...filesForPage])]\n      }\n\n      if (!this.isDevFallback) {\n        // Add the runtime build manifest file (generated later in this file)\n        // as a dependency for the app. If the flag is false, the file won't be\n        // downloaded by the client.\n        const buildManifestPath = buildNodejsLowPriorityPath(\n          '_buildManifest.js',\n          this.buildId\n        )\n        const ssgManifestPath = buildNodejsLowPriorityPath(\n          '_ssgManifest.js',\n          this.buildId\n        )\n        assetMap.lowPriorityFiles.push(buildManifestPath, ssgManifestPath)\n        compilation.emitAsset(\n          ssgManifestPath,\n          new sources.RawSource(srcEmptySsgManifest)\n        )\n      }\n\n      assetMap.pages = Object.keys(assetMap.pages)\n        .sort()\n        .reduce(\n          // eslint-disable-next-line\n          (a, c) => ((a[c] = assetMap.pages[c]), a),\n          {} as typeof assetMap.pages\n        )\n\n      let buildManifestName = BUILD_MANIFEST\n\n      if (this.isDevFallback) {\n        buildManifestName = `fallback-${BUILD_MANIFEST}`\n      }\n\n      compilation.emitAsset(\n        buildManifestName,\n        new sources.RawSource(JSON.stringify(assetMap, null, 2))\n      )\n\n      compilation.emitAsset(\n        `server/${MIDDLEWARE_BUILD_MANIFEST}.js`,\n        new sources.RawSource(`${createEdgeRuntimeManifest(assetMap)}`)\n      )\n\n      if (!this.isDevFallback) {\n        compilation.emitAsset(\n          `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_buildManifest.js`,\n          new sources.RawSource(\n            `self.__BUILD_MANIFEST = ${generateClientManifest(\n              assetMap,\n              this.rewrites,\n              this.clientRouterFilters,\n              compiler,\n              compilation\n            )};self.__BUILD_MANIFEST_CB && self.__BUILD_MANIFEST_CB()`\n          )\n        )\n      }\n    })\n  }\n\n  apply(compiler: webpack.Compiler) {\n    compiler.hooks.make.tap('NextJsBuildManifest', (compilation: any) => {\n      compilation.hooks.processAssets.tap(\n        {\n          name: 'NextJsBuildManifest',\n          stage: webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS,\n        },\n        () => {\n          this.createAssets(compiler, compilation)\n        }\n      )\n    })\n    return\n  }\n}\n"],"names":["devalue","webpack","sources","BUILD_MANIFEST","MIDDLEWARE_BUILD_MANIFEST","CLIENT_STATIC_FILES_PATH","CLIENT_STATIC_FILES_RUNTIME_MAIN","CLIENT_STATIC_FILES_RUNTIME_MAIN_APP","CLIENT_STATIC_FILES_RUNTIME_POLYFILLS_SYMBOL","CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH","SYSTEM_ENTRYPOINTS","getRouteFromEntrypoint","getSortedRoutes","Span","getCompilationSpan","createEdgeRuntimeManifest","normalizeRewritesForBuildManifest","processRoute","srcEmptySsgManifest","buildNodejsLowPriorityPath","filename","buildId","generateClientManifest","assetMap","rewrites","clientRouterFilters","compiler","compilation","compilationSpan","name","genClientManifestSpan","traceChild","traceFn","clientManifest","__rewrites","__routerFilterStatic","staticFilter","__routerFilterDynamic","dynamicFilter","appDependencies","Set","pages","sortedPageKeys","Object","keys","forEach","page","dependencies","filteredDeps","filter","dep","has","length","sortedPages","getEntrypointFiles","entrypoint","getFiles","file","test","map","replace","BuildManifestPlugin","constructor","options","isDevFallback","beforeFiles","afterFiles","fallback","appDirEnabled","createAssets","Error","createAssetsSpan","entrypoints","polyfillFiles","devFiles","lowPriorityFiles","rootMainFiles","rootMainFilesTree","mainFiles","get","compilationAssets","getAssets","p","endsWith","info","v","values","pagePath","filesForPage","buildManifestPath","ssgManifestPath","push","emitAsset","RawSource","sort","reduce","a","c","buildManifestName","JSON","stringify","apply","hooks","make","tap","processAssets","stage","Compilation","PROCESS_ASSETS_STAGE_ADDITIONS"],"mappings":"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","ignoreList":[0]}