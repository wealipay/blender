{"version":3,"sources":["../../../../src/build/webpack/loaders/next-middleware-loader.ts"],"sourcesContent":["import type {\n  ProxyConfig,\n  ProxyMatcher,\n} from '../../analysis/get-page-static-info'\nimport { getModuleBuildInfo } from './get-module-build-info'\nimport {\n  MIDDLEWARE_LOCATION_REGEXP,\n  PROXY_LOCATION_REGEXP,\n} from '../../../lib/constants'\nimport { loadEntrypoint } from '../../load-entrypoint'\n\nexport type MiddlewareLoaderOptions = {\n  absolutePagePath: string\n  page: string\n  rootDir: string\n  matchers?: string\n  preferredRegion: string | string[] | undefined\n  middlewareConfig: string\n}\n\n// matchers can have special characters that break the loader params\n// parsing so we base64 encode/decode the string\nexport function encodeMatchers(matchers: ProxyMatcher[]) {\n  return Buffer.from(JSON.stringify(matchers)).toString('base64')\n}\n\nexport function decodeMatchers(encodedMatchers: string) {\n  return JSON.parse(\n    Buffer.from(encodedMatchers, 'base64').toString()\n  ) as ProxyMatcher[]\n}\n\nexport default async function middlewareLoader(this: any) {\n  const {\n    absolutePagePath,\n    page,\n    rootDir,\n    matchers: encodedMatchers,\n    preferredRegion,\n    middlewareConfig: middlewareConfigBase64,\n  }: MiddlewareLoaderOptions = this.getOptions()\n  const matchers = encodedMatchers ? decodeMatchers(encodedMatchers) : undefined\n  const pagePath = this.utils.contextify(\n    this.context || this.rootContext,\n    absolutePagePath\n  )\n\n  const middlewareConfig: ProxyConfig = JSON.parse(\n    Buffer.from(middlewareConfigBase64, 'base64').toString()\n  )\n  const buildInfo = getModuleBuildInfo(this._module)\n  buildInfo.nextEdgeMiddleware = {\n    matchers,\n    page:\n      page.replace(\n        new RegExp(\n          `/(${MIDDLEWARE_LOCATION_REGEXP}|${PROXY_LOCATION_REGEXP})$`\n        ),\n        ''\n      ) || '/',\n  }\n  buildInfo.rootDir = rootDir\n  buildInfo.route = {\n    page,\n    absolutePagePath,\n    preferredRegion,\n    middlewareConfig,\n  }\n\n  return await loadEntrypoint('middleware', {\n    VAR_USERLAND: pagePath,\n    VAR_DEFINITION_PAGE: page,\n  })\n}\n"],"names":["getModuleBuildInfo","MIDDLEWARE_LOCATION_REGEXP","PROXY_LOCATION_REGEXP","loadEntrypoint","encodeMatchers","matchers","Buffer","from","JSON","stringify","toString","decodeMatchers","encodedMatchers","parse","middlewareLoader","absolutePagePath","page","rootDir","preferredRegion","middlewareConfig","middlewareConfigBase64","getOptions","undefined","pagePath","utils","contextify","context","rootContext","buildInfo","_module","nextEdgeMiddleware","replace","RegExp","route","VAR_USERLAND","VAR_DEFINITION_PAGE"],"mappings":"AAIA,SAASA,kBAAkB,QAAQ,0BAAyB;AAC5D,SACEC,0BAA0B,EAC1BC,qBAAqB,QAChB,yBAAwB;AAC/B,SAASC,cAAc,QAAQ,wBAAuB;AAWtD,oEAAoE;AACpE,gDAAgD;AAChD,OAAO,SAASC,eAAeC,QAAwB;IACrD,OAAOC,OAAOC,IAAI,CAACC,KAAKC,SAAS,CAACJ,WAAWK,QAAQ,CAAC;AACxD;AAEA,OAAO,SAASC,eAAeC,eAAuB;IACpD,OAAOJ,KAAKK,KAAK,CACfP,OAAOC,IAAI,CAACK,iBAAiB,UAAUF,QAAQ;AAEnD;AAEA,eAAe,eAAeI;IAC5B,MAAM,EACJC,gBAAgB,EAChBC,IAAI,EACJC,OAAO,EACPZ,UAAUO,eAAe,EACzBM,eAAe,EACfC,kBAAkBC,sBAAsB,EACzC,GAA4B,IAAI,CAACC,UAAU;IAC5C,MAAMhB,WAAWO,kBAAkBD,eAAeC,mBAAmBU;IACrE,MAAMC,WAAW,IAAI,CAACC,KAAK,CAACC,UAAU,CACpC,IAAI,CAACC,OAAO,IAAI,IAAI,CAACC,WAAW,EAChCZ;IAGF,MAAMI,mBAAgCX,KAAKK,KAAK,CAC9CP,OAAOC,IAAI,CAACa,wBAAwB,UAAUV,QAAQ;IAExD,MAAMkB,YAAY5B,mBAAmB,IAAI,CAAC6B,OAAO;IACjDD,UAAUE,kBAAkB,GAAG;QAC7BzB;QACAW,MACEA,KAAKe,OAAO,CACV,IAAIC,OACF,CAAC,EAAE,EAAE/B,2BAA2B,CAAC,EAAEC,sBAAsB,EAAE,CAAC,GAE9D,OACG;IACT;IACA0B,UAAUX,OAAO,GAAGA;IACpBW,UAAUK,KAAK,GAAG;QAChBjB;QACAD;QACAG;QACAC;IACF;IAEA,OAAO,MAAMhB,eAAe,cAAc;QACxC+B,cAAcX;QACdY,qBAAqBnB;IACvB;AACF","ignoreList":[0]}