{"version":3,"sources":["../../src/server/post-process.ts"],"sourcesContent":["import type { RenderOpts } from './render'\n\nimport { nonNullable } from '../lib/non-nullable'\n\ntype PostProcessorFunction =\n  | ((html: string) => Promise<string>)\n  | ((html: string) => string)\n\nasync function postProcessHTML(\n  content: string,\n  renderOpts: Pick<RenderOpts, 'optimizeCss' | 'distDir' | 'assetPrefix'>\n) {\n  const postProcessors: Array<PostProcessorFunction> = [\n    process.env.NEXT_RUNTIME !== 'edge' && renderOpts.optimizeCss\n      ? async (html: string) => {\n          // eslint-disable-next-line import/no-extraneous-dependencies\n          const Critters = require('critters') as typeof import('critters')\n          // @ts-expect-error -- interopRequireDefault\n          const cssOptimizer = new Critters({\n            ssrMode: true,\n            reduceInlineStyles: false,\n            path: renderOpts.distDir,\n            publicPath: `${renderOpts.assetPrefix}/_next/`,\n            preload: 'media',\n            fonts: false,\n            logLevel:\n              process.env.CRITTERS_LOG_LEVEL ||\n              (process.env.NODE_ENV === 'production' ? 'warn' : 'info'),\n            ...renderOpts.optimizeCss,\n          })\n          return await cssOptimizer.process(html)\n        }\n      : null,\n  ].filter(nonNullable)\n\n  for (const postProcessor of postProcessors) {\n    if (postProcessor) {\n      content = await postProcessor(content)\n    }\n  }\n  return content\n}\n\nexport { postProcessHTML }\n"],"names":["nonNullable","postProcessHTML","content","renderOpts","postProcessors","process","env","NEXT_RUNTIME","optimizeCss","html","Critters","require","cssOptimizer","ssrMode","reduceInlineStyles","path","distDir","publicPath","assetPrefix","preload","fonts","logLevel","CRITTERS_LOG_LEVEL","NODE_ENV","filter","postProcessor"],"mappings":"AAEA,SAASA,WAAW,QAAQ,sBAAqB;AAMjD,eAAeC,gBACbC,OAAe,EACfC,UAAuE;IAEvE,MAAMC,iBAA+C;QACnDC,QAAQC,GAAG,CAACC,YAAY,KAAK,UAAUJ,WAAWK,WAAW,GACzD,OAAOC;YACL,6DAA6D;YAC7D,MAAMC,WAAWC,QAAQ;YACzB,4CAA4C;YAC5C,MAAMC,eAAe,IAAIF,SAAS;gBAChCG,SAAS;gBACTC,oBAAoB;gBACpBC,MAAMZ,WAAWa,OAAO;gBACxBC,YAAY,GAAGd,WAAWe,WAAW,CAAC,OAAO,CAAC;gBAC9CC,SAAS;gBACTC,OAAO;gBACPC,UACEhB,QAAQC,GAAG,CAACgB,kBAAkB,IAC7BjB,CAAAA,QAAQC,GAAG,CAACiB,QAAQ,KAAK,eAAe,SAAS,MAAK;gBACzD,GAAGpB,WAAWK,WAAW;YAC3B;YACA,OAAO,MAAMI,aAAaP,OAAO,CAACI;QACpC,IACA;KACL,CAACe,MAAM,CAACxB;IAET,KAAK,MAAMyB,iBAAiBrB,eAAgB;QAC1C,IAAIqB,eAAe;YACjBvB,UAAU,MAAMuB,cAAcvB;QAChC;IACF;IACA,OAAOA;AACT;AAEA,SAASD,eAAe,GAAE","ignoreList":[0]}