{"version":3,"sources":["../../../src/server/request/draft-mode.ts"],"sourcesContent":["import {\n  getDraftModeProviderForCacheScope,\n  throwForMissingRequestStore,\n} from '../app-render/work-unit-async-storage.external'\n\nimport type { DraftModeProvider } from '../async-storage/draft-mode-provider'\n\nimport {\n  workAsyncStorage,\n  type WorkStore,\n} from '../app-render/work-async-storage.external'\nimport { workUnitAsyncStorage } from '../app-render/work-unit-async-storage.external'\nimport {\n  abortAndThrowOnSynchronousRequestDataAccess,\n  delayUntilRuntimeStage,\n  postponeWithTracking,\n  trackDynamicDataInDynamicRender,\n} from '../app-render/dynamic-rendering'\nimport { createDedupedByCallsiteServerErrorLoggerDev } from '../create-deduped-by-callsite-server-error-logger'\nimport { StaticGenBailoutError } from '../../client/components/static-generation-bailout'\nimport { DynamicServerError } from '../../client/components/hooks-server-context'\nimport { InvariantError } from '../../shared/lib/invariant-error'\nimport { ReflectAdapter } from '../web/spec-extension/adapters/reflect'\n\nexport function draftMode(): Promise<DraftMode> {\n  const callingExpression = 'draftMode'\n  const workStore = workAsyncStorage.getStore()\n  const workUnitStore = workUnitAsyncStorage.getStore()\n\n  if (!workStore || !workUnitStore) {\n    throwForMissingRequestStore(callingExpression)\n  }\n\n  switch (workUnitStore.type) {\n    case 'prerender-runtime':\n      // TODO(runtime-ppr): does it make sense to delay this? normally it's always microtasky\n      return delayUntilRuntimeStage(\n        workUnitStore,\n        createOrGetCachedDraftMode(workUnitStore.draftMode, workStore)\n      )\n    case 'request':\n      return createOrGetCachedDraftMode(workUnitStore.draftMode, workStore)\n\n    case 'cache':\n    case 'private-cache':\n    case 'unstable-cache':\n      // Inside of `\"use cache\"` or `unstable_cache`, draft mode is available if\n      // the outmost work unit store is a request store (or a runtime prerender),\n      // and if draft mode is enabled.\n      const draftModeProvider = getDraftModeProviderForCacheScope(\n        workStore,\n        workUnitStore\n      )\n\n      if (draftModeProvider) {\n        return createOrGetCachedDraftMode(draftModeProvider, workStore)\n      }\n\n    // Otherwise, we fall through to providing an empty draft mode.\n    // eslint-disable-next-line no-fallthrough\n    case 'prerender':\n    case 'prerender-client':\n    case 'prerender-ppr':\n    case 'prerender-legacy':\n      // Return empty draft mode\n      return createOrGetCachedDraftMode(null, workStore)\n\n    default:\n      return workUnitStore satisfies never\n  }\n}\n\nfunction createOrGetCachedDraftMode(\n  draftModeProvider: DraftModeProvider | null,\n  workStore: WorkStore | undefined\n): Promise<DraftMode> {\n  const cacheKey = draftModeProvider ?? NullDraftMode\n  const cachedDraftMode = CachedDraftModes.get(cacheKey)\n\n  if (cachedDraftMode) {\n    return cachedDraftMode\n  }\n\n  if (process.env.NODE_ENV === 'development' && !workStore?.isPrefetchRequest) {\n    const route = workStore?.route\n    return createDraftModeWithDevWarnings(draftModeProvider, route)\n  } else {\n    return Promise.resolve(new DraftMode(draftModeProvider))\n  }\n}\n\ninterface CacheLifetime {}\nconst NullDraftMode = {}\nconst CachedDraftModes = new WeakMap<CacheLifetime, Promise<DraftMode>>()\n\nfunction createDraftModeWithDevWarnings(\n  underlyingProvider: null | DraftModeProvider,\n  route: undefined | string\n): Promise<DraftMode> {\n  const instance = new DraftMode(underlyingProvider)\n  const promise = Promise.resolve(instance)\n\n  const proxiedPromise = new Proxy(promise, {\n    get(target, prop, receiver) {\n      switch (prop) {\n        case 'isEnabled':\n          warnForSyncAccess(route, `\\`draftMode().${prop}\\``)\n          break\n        case 'enable':\n        case 'disable': {\n          warnForSyncAccess(route, `\\`draftMode().${prop}()\\``)\n          break\n        }\n        default: {\n          // We only warn for well-defined properties of the draftMode object.\n        }\n      }\n\n      return ReflectAdapter.get(target, prop, receiver)\n    },\n  })\n\n  return proxiedPromise\n}\n\nclass DraftMode {\n  /**\n   * @internal - this declaration is stripped via `tsc --stripInternal`\n   */\n  private readonly _provider: null | DraftModeProvider\n\n  constructor(provider: null | DraftModeProvider) {\n    this._provider = provider\n  }\n  get isEnabled() {\n    if (this._provider !== null) {\n      return this._provider.isEnabled\n    }\n    return false\n  }\n  public enable() {\n    // We have a store we want to track dynamic data access to ensure we\n    // don't statically generate routes that manipulate draft mode.\n    trackDynamicDraftMode('draftMode().enable()', this.enable)\n    if (this._provider !== null) {\n      this._provider.enable()\n    }\n  }\n  public disable() {\n    trackDynamicDraftMode('draftMode().disable()', this.disable)\n    if (this._provider !== null) {\n      this._provider.disable()\n    }\n  }\n}\nconst warnForSyncAccess = createDedupedByCallsiteServerErrorLoggerDev(\n  createDraftModeAccessError\n)\n\nfunction createDraftModeAccessError(\n  route: string | undefined,\n  expression: string\n) {\n  const prefix = route ? `Route \"${route}\" ` : 'This route '\n  return new Error(\n    `${prefix}used ${expression}. ` +\n      `\\`draftMode()\\` returns a Promise and must be unwrapped with \\`await\\` or \\`React.use()\\` before accessing its properties. ` +\n      `Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis`\n  )\n}\n\nfunction trackDynamicDraftMode(expression: string, constructorOpt: Function) {\n  const workStore = workAsyncStorage.getStore()\n  const workUnitStore = workUnitAsyncStorage.getStore()\n\n  if (workStore) {\n    // We have a store we want to track dynamic data access to ensure we\n    // don't statically generate routes that manipulate draft mode.\n    if (workUnitStore?.phase === 'after') {\n      throw new Error(\n        `Route ${workStore.route} used \"${expression}\" inside \\`after()\\`. The enabled status of \\`draftMode()\\` can be read inside \\`after()\\` but you cannot enable or disable \\`draftMode()\\`. See more info here: https://nextjs.org/docs/app/api-reference/functions/after`\n      )\n    }\n\n    if (workStore.dynamicShouldError) {\n      throw new StaticGenBailoutError(\n        `Route ${workStore.route} with \\`dynamic = \"error\"\\` couldn't be rendered statically because it used \\`${expression}\\`. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering`\n      )\n    }\n\n    if (workUnitStore) {\n      switch (workUnitStore.type) {\n        case 'cache':\n        case 'private-cache': {\n          const error = new Error(\n            `Route ${workStore.route} used \"${expression}\" inside \"use cache\". The enabled status of \\`draftMode()\\` can be read in caches but you must not enable or disable \\`draftMode()\\` inside a cache. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n          )\n          Error.captureStackTrace(error, constructorOpt)\n          workStore.invalidDynamicUsageError ??= error\n          throw error\n        }\n        case 'unstable-cache':\n          throw new Error(\n            `Route ${workStore.route} used \"${expression}\" inside a function cached with \\`unstable_cache()\\`. The enabled status of \\`draftMode()\\` can be read in caches but you must not enable or disable \\`draftMode()\\` inside a cache. See more info here: https://nextjs.org/docs/app/api-reference/functions/unstable_cache`\n          )\n\n        case 'prerender':\n        case 'prerender-runtime': {\n          const error = new Error(\n            `Route ${workStore.route} used ${expression} without first calling \\`await connection()\\`. See more info here: https://nextjs.org/docs/messages/next-prerender-sync-headers`\n          )\n          return abortAndThrowOnSynchronousRequestDataAccess(\n            workStore.route,\n            expression,\n            error,\n            workUnitStore\n          )\n        }\n        case 'prerender-client':\n          const exportName = '`draftMode`'\n          throw new InvariantError(\n            `${exportName} must not be used within a Client Component. Next.js should be preventing ${exportName} from being included in Client Components statically, but did not in this case.`\n          )\n        case 'prerender-ppr':\n          return postponeWithTracking(\n            workStore.route,\n            expression,\n            workUnitStore.dynamicTracking\n          )\n        case 'prerender-legacy':\n          workUnitStore.revalidate = 0\n\n          const err = new DynamicServerError(\n            `Route ${workStore.route} couldn't be rendered statically because it used \\`${expression}\\`. See more info here: https://nextjs.org/docs/messages/dynamic-server-error`\n          )\n          workStore.dynamicUsageDescription = expression\n          workStore.dynamicUsageStack = err.stack\n\n          throw err\n        case 'request':\n          trackDynamicDataInDynamicRender(workUnitStore)\n          break\n        default:\n          workUnitStore satisfies never\n      }\n    }\n  }\n}\n"],"names":["getDraftModeProviderForCacheScope","throwForMissingRequestStore","workAsyncStorage","workUnitAsyncStorage","abortAndThrowOnSynchronousRequestDataAccess","delayUntilRuntimeStage","postponeWithTracking","trackDynamicDataInDynamicRender","createDedupedByCallsiteServerErrorLoggerDev","StaticGenBailoutError","DynamicServerError","InvariantError","ReflectAdapter","draftMode","callingExpression","workStore","getStore","workUnitStore","type","createOrGetCachedDraftMode","draftModeProvider","cacheKey","NullDraftMode","cachedDraftMode","CachedDraftModes","get","process","env","NODE_ENV","isPrefetchRequest","route","createDraftModeWithDevWarnings","Promise","resolve","DraftMode","WeakMap","underlyingProvider","instance","promise","proxiedPromise","Proxy","target","prop","receiver","warnForSyncAccess","constructor","provider","_provider","isEnabled","enable","trackDynamicDraftMode","disable","createDraftModeAccessError","expression","prefix","Error","constructorOpt","phase","dynamicShouldError","error","captureStackTrace","invalidDynamicUsageError","exportName","dynamicTracking","revalidate","err","dynamicUsageDescription","dynamicUsageStack","stack"],"mappings":"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","ignoreList":[0]}